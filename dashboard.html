<script>
    // Gerencia todos os dados e lógica da aplicação
    const App = {
        // Dados de exemplo, carregados do Local Storage ou padrão
        projects: JSON.parse(localStorage.getItem('projects')) || [
            { id: 1, name: "Dashboard de Analytics", responsible: "João Silva", status: "active", progress: 75 },
            { id: 2, name: "Integração de API", responsible: "Maria Souza", status: "pending", progress: 30 },
            { id: 3, name: "Atualização de Segurança", responsible: "Carlos Oliveira", status: "active", progress: 90 },
            { id: 4, name: "Migração de Banco de Dados", responsible: "Ana Santos", status: "inactive", progress: 10 }
        ],
        nextProjectId: 5, // Ajuda a simular novos IDs

        // ------------------------- RENDERIZAÇÃO E UI -------------------------

        // Renderiza a tabela de projetos com as novas AÇÕES
        renderProjects() {
            const projectsBody = document.getElementById('projectsBody');
            if (!projectsBody) return;

            projectsBody.innerHTML = ''; 
            
            this.projects.forEach(project => {
                const row = document.createElement('tr');
                let statusClass, statusText;
                
                switch(project.status) {
                    case 'active': statusClass = 'status-active'; statusText = 'Ativo'; break;
                    case 'pending': statusClass = 'status-pending'; statusText = 'Pendente'; break;
                    case 'inactive': statusClass = 'status-inactive'; statusText = 'Inativo'; break;
                    default: statusClass = 'status-pending'; statusText = 'Pendente'; 
                }
                
                let progressColor;
                if (project.progress < 30) { progressColor = 'var(--danger)'; } 
                else if (project.progress < 70) { progressColor = 'var(--warning)'; } 
                else { progressColor = 'var(--success)'; }
                
                row.innerHTML = `
                    <td>${project.name}</td>
                    <td>${project.responsible}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar-wrap">
                                <div class="progress-bar" style="width: ${project.progress}%; background: ${progressColor};"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: ${progressColor}; font-weight: 600;">${project.progress}%</span>
                        </div>
                    </td>
                    <td>
                        <button class="card-action edit-btn" data-project-id="${project.id}" data-action="openEditModal" title="Editar Projeto">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                projectsBody.appendChild(row);
            });
            localStorage.setItem('projects', JSON.stringify(this.projects));
        },

        // Atualiza o Progress Ring (Gráfico de Conversão)
        updateProgressRing(percent) {
            const ring = document.getElementById('conversionRing');
            const text = document.getElementById('conversionText');
            if (!ring) return;

            const radius = ring.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            // 25 é o valor do raio (r="25")
            const offset = circumference - (percent / 100) * circumference;

            ring.style.strokeDasharray = `${circumference} ${circumference}`;
            ring.style.strokeDashoffset = offset;
            text.textContent = `${percent}%`;
        },
        
        // Exibe o Toast de Notificação
        showToast(message, type = 'success') {
            const toast = document.getElementById('successToast');
            const messageEl = document.querySelector('#successToast .toast-message');
            const titleEl = document.querySelector('#successToast .toast-title');
            const iconEl = document.querySelector('#successToast .toast-icon');

            if (!toast) return;

            // Configurações baseadas no tipo
            if (type === 'error') {
                toast.style.borderColor = 'var(--danger)';
                iconEl.style.color = 'var(--danger)';
                iconEl.className = 'fas fa-times-circle toast-icon';
                titleEl.textContent = 'Atenção!';
            } else {
                toast.style.borderColor = 'var(--success)';
                iconEl.style.color = 'var(--success)';
                iconEl.className = 'fas fa-check-circle toast-icon';
                titleEl.textContent = 'Sucesso!';
            }
            
            messageEl.textContent = message;
            
            toast.classList.add('show');
            clearTimeout(this.toastTimeout);
            this.toastTimeout = setTimeout(() => toast.classList.remove('show'), 4000);
        },

        // Fecha todos os Modais abertos
        closeModals() {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
        },

        // ------------------------- HANDLERS DE AÇÕES -------------------------

        // 1. Ação para Nova Navegação (Configurações, Usuários, Relatórios)
        handleNavigation(e) {
            e.preventDefault();
            // Pega o texto do link para usar no Toast
            const linkText = e.target.closest('.nav-item').textContent.trim();
            
            // Simula a mudança de página
            this.showToast(`Acessando a funcionalidade: ${linkText}...`, 'success');
        },

        // 2. Ação do Botão SAIR (Logout)
        handleLogout() {
            this.showToast('Realizando logoff... Encerrando sessão.', 'error');
            setTimeout(() => {
                // Simulação de deslogar
                document.body.innerHTML = '<h1 style="padding: 50px; text-align: center; color: var(--text); font-family: Inter, sans-serif;">Sessão Encerrada.</h1><p style="text-align: center; color: var(--text-light); font-family: Inter, sans-serif;">Obrigado por usar o Zyx.</p>';
            }, 800);
        },

        // 3. Abre o Modal de Edição (Ação da Tabela)
        handleOpenEditModal(projectId) {
            // Cria e abre o modal de edição (pois não existia no seu HTML)
            const project = this.projects.find(p => p.id === projectId);
            if (!project) return this.showToast('Projeto não encontrado.', 'error');

            // Adiciona um modal de edição dinamicamente (para evitar "tela branca")
            let editModal = document.getElementById('editProjectModal');
            if (!editModal) {
                 const modalHTML = `
                    <div class="modal" id="editProjectModal">
                        <div class="modal-content">
                            <h3 class="modal-title" id="editModalTitle">Editar Projeto</h3>
                            <form id="editProjectForm">
                                <input type="hidden" id="editProjectId">
                                <div class="form-group"><label>Nome</label><input type="text" id="editProjectName" required></div>
                                <div class="form-group"><label>Responsável</label><input type="text" id="editProjectOwner" required></div>
                                <div class="form-group"><label>Status</label><select id="editProjectStatus">
                                    <option value="active">Ativo</option><option value="pending">Pendente</option><option value="inactive">Inativo</option>
                                </select></div>
                                <div class="form-group"><label>Progresso (%)</label><input type="number" id="editProjectProgress" min="0" max="100" required></div>
                                <div class="form-actions">
                                    <button type="button" class="secondary" data-action="closeModal">Cancelar</button>
                                    <button type="submit">Salvar Alterações</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                editModal = document.getElementById('editProjectModal');
                
                // Adiciona o listener para o novo formulário
                document.getElementById('editProjectForm').addEventListener('submit', this.handleSaveEdit.bind(this));
            }

            // Preenche e mostra o modal
            document.getElementById('editModalTitle').textContent = `Editar: ${project.name}`;
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('editProjectName').value = project.name;
            document.getElementById('editProjectOwner').value = project.responsible;
            document.getElementById('editProjectStatus').value = project.status;
            document.getElementById('editProjectProgress').value = project.progress;

            editModal.classList.add('active');
        },
        
        // 4. Salva o Modal de Edição
        handleSaveEdit(e) {
            e.preventDefault();
            const form = e.target;
            
            const id = parseInt(form.elements['editProjectId'].value);
            const name = form.elements['editProjectName'].value;
            const responsible = form.elements['editProjectOwner'].value;
            const status = form.elements['editProjectStatus'].value;
            const progress = parseInt(form.elements['editProjectProgress'].value);

            const projectIndex = this.projects.findIndex(p => p.id === id);

            if (projectIndex !== -1) {
                // Atualiza o projeto no array
                this.projects[projectIndex] = { id, name, responsible, status, progress };
                
                // Salva e renderiza
                this.renderProjects();
                this.closeModals();
                this.showToast(`Projeto ${name} atualizado com sucesso!`);
            } else {
                this.showToast('Erro ao salvar: Projeto não encontrado.', 'error');
            }
        },

        // ------------------------- INICIALIZAÇÃO E LISTENERS -------------------------
        
        init() {
            this.renderProjects();
            this.updateProgressRing(80);

            // Listener para o botão de SAIR
            document.getElementById('logoutBtn').addEventListener('click', this.handleLogout.bind(this));

            // Listener para os botões de navegação (Configurações, Usuários, Relatórios)
            document.querySelectorAll('.sidebar .nav-item').forEach(navItem => {
                // Evita adicionar o listener ao Dashboard (item ativo) e Dados do Sistema (já tem modal)
                if (!navItem.classList.contains('active') && navItem.id !== 'systemDataBtn') {
                     navItem.addEventListener('click', this.handleNavigation.bind(this));
                }
            });
            
            // Listener Global para Modais e Ações da Tabela
            document.addEventListener('click', (e) => {
                // Ação da Tabela: Abrir Edição
                const actionBtn = e.target.closest('[data-action="openEditModal"]');
                if (actionBtn && actionBtn.dataset.projectId) {
                    this.handleOpenEditModal(parseInt(actionBtn.dataset.projectId));
                    return;
                }

                // Ação Genérica: Fechar Modal
                const closeModalBtn = e.target.closest('[data-action="closeModal"]');
                if (closeModalBtn) {
                    this.closeModals();
                    return;
                }
            });
            
            // Listener para o botão de fechar modal (X) e Cancelar nos modais existentes
            document.querySelectorAll('[data-modal-close]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault(); // Impede ação padrão da tag <a> se for o caso
                    this.closeModals();
                });
            });

            // Lógica do Formulário de Novo Projeto (Mantida)
            const projectForm = document.getElementById('projectForm');
            projectForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const projectName = document.getElementById('projectName').value;
                const responsibleName = document.getElementById('projectOwner').value;

                this.projects.unshift({
                    id: this.nextProjectId++,
                    name: projectName,
                    responsible: responsibleName,
                    status: 'pending',
                    progress: 0
                });
                
                this.renderProjects();
                this.closeModals();
                this.showToast(`Projeto "${projectName}" criado com sucesso.`);
                projectForm.reset();
            });

            // Lógica do Sidebar (Mobile)
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menuToggleBtn');

            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Abre o modal de Dados do Sistema
            document.getElementById('systemDataBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('systemDataModal').classList.add('active');
            });
        }
    };

    // Inicia a aplicação
    document.addEventListener('DOMContentLoaded', () => App.init());
</script>
