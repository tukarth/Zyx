<script>
    // Objeto principal para gerenciar toda a lógica do dashboard
    const App = {
        // Dados (Inicia com dados padrão ou recupera do localStorage)
        projects: JSON.parse(localStorage.getItem('projects')) || [
            { id: 1, name: "Dashboard de Analytics", responsible: "João Silva", status: "active", progress: 75 },
            { id: 2, name: "Integração de API", responsible: "Maria Souza", status: "pending", progress: 30 },
            { id: 3, name: "Atualização de Segurança", responsible: "Carlos Oliveira", status: "active", progress: 90 },
            { id: 4, name: "Migração de Banco de Dados", responsible: "Ana Santos", status: "inactive", progress: 10 }
        ],
        nextProjectId: 5,
        
        // ----------------------------------------------------
        // 1. RENDERIZAÇÃO E ATUALIZAÇÃO DA UI
        // ----------------------------------------------------

        // Renderiza a tabela de projetos
        renderProjects() {
            const projectsBody = document.getElementById('projectsBody');
            projectsBody.innerHTML = '';
            
            this.projects.forEach(project => {
                const row = document.createElement('tr');
                let statusClass, statusText;
                
                switch(project.status) {
                    case 'active': statusClass = 'status-active'; statusText = 'Ativo'; break;
                    case 'pending': statusClass = 'status-pending'; statusText = 'Pendente'; break;
                    case 'inactive': statusClass = 'status-inactive'; statusText = 'Inativo'; break;
                }
                
                let progressColor;
                if (project.progress < 30) { progressColor = 'var(--danger)'; } 
                else if (project.progress < 70) { progressColor = 'var(--warning)'; } 
                else { progressColor = 'var(--success)'; }
                
                row.innerHTML = `
                    <td>${project.name}</td>
                    <td>${project.responsible}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar-wrap">
                                <div class="progress-bar" style="width: ${project.progress}%; background: ${progressColor};"></div>
                            </div>
                            <span style="font-size: 0.85rem; color: ${progressColor}; font-weight: 600;">${project.progress}%</span>
                        </div>
                    </td>
                    <td>
                        <button class="card-action edit-btn" data-project-id="${project.id}" data-action="openEditModal" title="Editar Projeto">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                projectsBody.appendChild(row);
            });
            localStorage.setItem('projects', JSON.stringify(this.projects));
        },

        // Atualiza o Progress Ring (Taxa de Conversão)
        updateProgressRing(percent) {
            const ring = document.getElementById('conversionRing');
            const text = document.getElementById('conversionText');
            if (!ring) return;

            const radius = ring.r.baseVal.value;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (percent / 100) * circumference;

            ring.style.strokeDasharray = `${circumference} ${circumference}`;
            ring.style.strokeDashoffset = offset;
            text.textContent = `${percent}%`;
        },
        
        // ----------------------------------------------------
        // 2. MODAIS E TOASTS
        // ----------------------------------------------------
        
        openModal(modalId) {
            const modal = document.getElementById(modalId);
            const overlay = document.getElementById('overlay');
            if (modal) {
                modal.classList.add('active');
                overlay.classList.add('active');
            }
        },

        closeModals() {
            document.querySelectorAll('.modal.active').forEach(modal => {
                modal.classList.remove('active');
            });
            document.getElementById('overlay').classList.remove('active');
        },

        showToast(message, type = 'success') {
            const toast = document.getElementById('successToast');
            const messageEl = document.getElementById('toastMessage');
            
            // Configurações do Toast
            toast.className = 'toast show'; 
            if (type === 'error') {
                toast.style.borderColor = 'var(--danger)';
                toast.querySelector('.toast-icon').style.color = 'var(--danger)';
                toast.querySelector('.toast-icon').className = 'fas fa-times-circle toast-icon';
            } else {
                toast.style.borderColor = 'var(--success)';
                toast.querySelector('.toast-icon').style.color = 'var(--success)';
                toast.querySelector('.toast-icon').className = 'fas fa-check-circle toast-icon';
            }
            
            messageEl.textContent = message;
            
            clearTimeout(this.toastTimeout);
            this.toastTimeout = setTimeout(() => toast.classList.remove('show'), 4000);
        },
        
        // ----------------------------------------------------
        // 3. HANDLERS DE FORMULÁRIO E TABELA
        // ----------------------------------------------------
        
        handleNewProject(e) {
            e.preventDefault();
            const form = e.target;
            
            const newProject = {
                id: App.nextProjectId++,
                name: form.elements.name.value,
                responsible: form.elements.responsible.value,
                status: 'pending',
                progress: 0
            };

            App.projects.unshift(newProject);
            App.renderProjects();
            App.closeModals();
            App.showToast(`Projeto "${newProject.name}" criado com sucesso!`);
            form.reset();
        },
        
        handleOpenEditModal(projectId) {
            const project = App.projects.find(p => p.id === projectId);
            if (!project) return App.showToast('Projeto não encontrado.', 'error');

            const form = document.getElementById('editProjectForm');
            
            // Preenche o formulário com os dados do projeto
            document.getElementById('editModalTitle').textContent = `Editar: ${project.name}`;
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('editProjectName').value = project.name;
            document.getElementById('editProjectOwner').value = project.responsible;
            document.getElementById('editProjectStatus').value = project.status;
            document.getElementById('editProjectProgress').value = project.progress;

            App.openModal('editProjectModal');
        },
        
        handleSaveEdit(e) {
            e.preventDefault();
            const form = e.target;
            
            const id = parseInt(form.elements['editProjectId'].value);
            const name = form.elements['editProjectName'].value;
            const responsible = form.elements['editProjectOwner'].value;
            const status = form.elements['editProjectStatus'].value;
            const progress = parseInt(form.elements['editProjectProgress'].value);

            const projectIndex = App.projects.findIndex(p => p.id === id);

            if (projectIndex !== -1) {
                App.projects[projectIndex] = { id, name, responsible, status, progress };
                App.renderProjects();
                App.closeModals();
                App.showToast(`Projeto ${name} atualizado com sucesso!`);
            } else {
                App.showToast('Erro ao salvar: Projeto não encontrado.', 'error');
            }
        },

        // ----------------------------------------------------
        // 4. HANDLERS DE NAVEGAÇÃO
        // ----------------------------------------------------
        
        // Handler para navegação dos links do sidebar
        handleNavigation(e) {
            e.preventDefault();
            const linkText = e.target.closest('.nav-item').textContent.trim();
            
            // Simula o carregamento da nova página/funcionalidade
            App.showToast(`Navegando para: ${linkText}...`, 'success');
            
            // Lógica de "mudar de página" (apenas para fins didáticos)
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            e.target.closest('.nav-item').classList.add('active');
            
            // No mundo real: window.location.href = e.target.href;
        },

        // Handler para o botão Sair/Logout
        handleLogout() {
            App.showToast('Realizando logoff... Esperamos você de volta!', 'error');
            setTimeout(() => {
                // Em um sistema real, aqui você faria a limpeza da sessão e redirecionamento
                document.body.innerHTML = '<h1 style="padding: 50px; text-align: center; color: var(--text); font-family: Inter, sans-serif;">Sessão Encerrada.</h1><p style="text-align: center; color: var(--text-light); font-family: Inter, sans-serif;">Obrigado por usar o Zyx.</p>';
            }, 800);
        },

        // ----------------------------------------------------
        // 5. INICIALIZAÇÃO E EVENT LISTENERS
        // ----------------------------------------------------
        
        init() {
            this.renderProjects();
            this.updateProgressRing(80);
            
            // 5.1. Listener Global para Modais e Botões de Ação
            document.addEventListener('click', (e) => {
                const target = e.target.closest('[data-modal-target]');
                const action = e.target.closest('[data-action]');
                
                // Abre Modais (Novo Projeto, Dados do Sistema)
                if (target) {
                    e.preventDefault();
                    this.openModal(target.dataset.modalTarget);
                } 
                
                // Ações de Botões (Fechar Modal, Fechar Toast, Editar Tabela)
                else if (action) {
                    const actionType = action.dataset.action;
                    if (actionType === 'closeModal') {
                        this.closeModals();
                    } else if (actionType === 'closeToast') {
                        document.getElementById('successToast').classList.remove('show');
                    } else if (actionType === 'openEditModal' && action.dataset.projectId) {
                        // Ação da Tabela que abre o modal de edição (AGORA FUNCIONAL)
                        this.handleOpenEditModal(parseInt(action.dataset.projectId));
                    }
                }
            });
            
            // 5.2. Listeners de Formulários
            document.getElementById('projectForm').addEventListener('submit', this.handleNewProject);
            document.getElementById('editProjectForm').addEventListener('submit', this.handleSaveEdit);
            
            // 5.3. Listeners de Navegação (Configurações, Usuários, Relatórios)
            // Seleciona todos os links do nav que não têm um data-modal-target
            document.querySelectorAll('.sidebar .nav-item:not([data-modal-target])').forEach(navItem => {
                // Garante que o Dashboard (link ativo) e outros links sem ação direta sejam tratados
                if (!navItem.classList.contains('active')) {
                     navItem.addEventListener('click', this.handleNavigation);
                }
            });
            
            // 5.4. Botão de Atualizar e Logout (AGORA FUNCIONAL)
            document.getElementById('refreshProjects').addEventListener('click', () => {
                this.renderProjects();
                this.showToast('Projetos atualizados com sucesso.');
            });
            
            document.getElementById('logoutBtn').addEventListener('click', this.handleLogout);
            
            // 5.5. Lógica Mobile/Sidebar (Mantida para responsividade)
            const sidebar = document.getElementById('sidebar');
            const menuToggleBtn = document.getElementById('menuToggleBtn');
            const overlay = document.getElementById('overlay');
            
            menuToggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                this.closeModals();
            });
        }
    };

    // Inicia a aplicação após o DOM estar totalmente carregado
    document.addEventListener('DOMContentLoaded', () => App.init());
</script>
