// ======================================================================================================================
// ----------------------------------------------------------------------------------------------------------------------
// MÓDULO PRINCIPAL DE APLICAÇÃO (APP CORE) - CÓDIGO ATUALIZADO
// ----------------------------------------------------------------------------------------------------------------------
// ======================================================================================================================

const AppCore = {
    // VARIÁVEIS DE ESTADO
    projects: [],
    nextProjectId: 5,
    toastTimeout: null,
    
    // Mapeamento de seletores
    SELECTORS: {
        projectsBody: '#projectsBody',
        sidebar: '#sidebar',
        menuToggleBtn: '#menuToggleBtn',
        logoutBtn: '#logoutBtn',
        refreshBtn: '#refreshProjects',
        newProjectBtn: '#newProjectBtn',
        conversionRing: '#conversionRing',
        conversionText: '#conversionText',
        projectForm: '#projectForm',
        editProjectForm: '#editProjectForm',
        successToast: '#successToast',
        navItems: '.sidebar .nav-item',
        allModals: '.modal',
        closeModalBtns: '[data-action="closeModal"]',
        openModalBtns: '[data-modal-target]',
        tableEditBtns: '.edit-btn', // Mudança: Usa a classe do botão
        notificationsBtn: '#notificationsBtn',
        userAvatar: '#userAvatar'
    },

    // ==================================================================================================================
    // 1. MÓDULO DE DADOS E ARMAZENAMENTO (DATA MODULE)
    // ==================================================================================================================
    DataModule: {
        // Função para carregar os dados iniciais (MANTIDA)
        loadInitialData: () => {
            const storedProjects = localStorage.getItem('projects');
            if (storedProjects) {
                AppCore.projects = JSON.parse(storedProjects);
                const maxId = AppCore.projects.reduce((max, p) => (p.id > max ? p.id : max), 0);
                AppCore.nextProjectId = maxId + 1;
            } else {
                AppCore.projects = [
                    { id: 1, name: "Dashboard de Analytics", responsible: "João Silva", status: "active", progress: 75 },
                    { id: 2, name: "Integração de API", responsible: "Maria Souza", status: "pending", progress: 30 },
                    { id: 3, name: "Atualização de Segurança", responsible: "Carlos Oliveira", status: "active", progress: 90 },
                    { id: 4, name: "Migração de Banco de Dados", responsible: "Ana Santos", status: "inactive", progress: 10 }
                ];
                AppCore.nextProjectId = 5;
            }
        },

        // Função para persistir os dados (MANTIDA)
        saveData: () => {
            localStorage.setItem('projects', JSON.stringify(AppCore.projects));
        },

        // Adiciona um novo projeto (MANTIDA)
        addNewProject: (name, responsible) => {
            const newProject = {
                id: AppCore.nextProjectId++,
                name: name,
                responsible: responsible,
                status: 'pending',
                progress: 0
            };
            AppCore.projects.unshift(newProject);
            DataModule.saveData();
            return newProject;
        },
        
        // Encontra um projeto pelo ID (MANTIDA)
        getProjectById: (id) => {
            return AppCore.projects.find(p => p.id === id);
        },

        // Atualiza um projeto existente (MANTIDA)
        updateProject: (id, name, responsible, status, progress) => {
            const index = AppCore.projects.findIndex(p => p.id === id);
            if (index !== -1) {
                AppCore.projects[index] = { id, name, responsible, status, progress };
                DataModule.saveData();
                return true;
            }
            return false;
        }
    },
    get DataModule() { return this._DataModule || (this._DataModule = this.DataModule); }
};

// ======================================================================================================================
// 2. MÓDULO DE RENDERIZAÇÃO E ATUALIZAÇÃO DA INTERFACE (UI MODULE) - ATUALIZADO
// ======================================================================================================================
const UIModule = {
    
    // RENDERIZAÇÃO DA TABELA (MELHORIA na identificação do botão de edição)
    renderProjects: () => {
        const projectsBody = document.querySelector(AppCore.SELECTORS.projectsBody);
        if (!projectsBody) return;

        projectsBody.innerHTML = ''; 
        
        AppCore.projects.forEach(project => {
            const row = document.createElement('tr');
            let statusClass, statusText;
            
            switch(project.status) {
                case 'active': statusClass = 'status-active'; statusText = 'Ativo'; break;
                case 'pending': statusClass = 'status-pending'; statusText = 'Pendente'; break;
                case 'inactive': statusClass = 'status-inactive'; statusText = 'Inativo'; break;
                default: statusClass = 'status-pending'; statusText = 'Pendente'; 
            }
            
            let progressColor;
            if (project.progress < 30) { progressColor = 'var(--danger)'; } 
            else if (project.progress < 70) { progressColor = 'var(--warning)'; } 
            else { progressColor = 'var(--success)'; }
            
            row.innerHTML = `
                <td>${project.name}</td>
                <td>${project.responsible}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>
                    <div class="progress-cell">
                        <div class="progress-bar-wrap">
                            <div class="progress-bar" style="width: ${project.progress}%; background: ${progressColor};"></div>
                        </div>
                        <span style="font-size: 0.85rem; color: ${progressColor}; font-weight: 600;">${project.progress}%</span>
                    </div>
                </td>
                <td>
                    <button class="card-action edit-btn" data-project-id="${project.id}" data-action="editProject" title="Editar Projeto">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            `;
            projectsBody.appendChild(row);
        });
        
        // REAPLICAÇÃO DOS LISTENERS DE EDIÇÃO APÓS RENDERIZAÇÃO
        // Esta é a chave para os botões da tabela funcionarem após o AJAX/Render
        document.querySelectorAll(AppCore.SELECTORS.tableEditBtns).forEach(btn => {
            btn.addEventListener('click', EventHandlers.handleOpenEditModal);
        });
    },

    // ATUALIZAÇÃO DO PROGRESS RING (MANTIDA)
    updateProgressRing: (percent) => {
        const ring = document.querySelector(AppCore.SELECTORS.conversionRing);
        const text = document.querySelector(AppCore.SELECTORS.conversionText);
        if (!ring) return;

        const radius = ring.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (percent / 100) * circumference;

        ring.style.strokeDasharray = `${circumference} ${circumference}`;
        ring.style.strokeDashoffset = offset;
        text.textContent = `${percent}%`;
    },
    
    // EXIBIÇÃO DE TOAST (MANTIDA)
    showToast: (message, type = 'success') => {
        const toast = document.querySelector(AppCore.SELECTORS.successToast);
        const messageEl = toast ? toast.querySelector('.toast-message') : null;
        const titleEl = toast ? toast.querySelector('.toast-title') : null;
        const iconEl = toast ? toast.querySelector('.toast-icon') : null;

        if (!toast) return;

        clearTimeout(AppCore.toastTimeout);

        if (type === 'error' || type === 'logout') {
            toast.style.borderColor = 'var(--danger)';
            iconEl.style.color = 'var(--danger)';
            iconEl.className = 'fas fa-times-circle toast-icon';
            titleEl.textContent = type === 'logout' ? 'Sessão Encerrada!' : 'Atenção!';
        } else if (type === 'warning') {
            toast.style.borderColor = 'var(--warning)';
            iconEl.style.color = 'var(--warning)';
            iconEl.className = 'fas fa-exclamation-triangle toast-icon';
            titleEl.textContent = 'Aviso!';
        } else {
            toast.style.borderColor = 'var(--success)';
            iconEl.style.color = 'var(--success)';
            iconEl.className = 'fas fa-check-circle toast-icon';
            titleEl.textContent = 'Sucesso!';
        }
        
        messageEl.textContent = message;
        
        toast.classList.add('show');
        AppCore.toastTimeout = setTimeout(() => toast.classList.remove('show'), 4000);
    },
    
    // LÓGICA DE MODAIS (MANTIDA)
    openModal: (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('active');
        }
    },

    closeModals: () => {
        document.querySelectorAll(AppCore.SELECTORS.allModals).forEach(modal => {
            modal.classList.remove('active');
        });
        document.querySelector(AppCore.SELECTORS.sidebar).classList.remove('active');
    },

    // LÓGICA MOBILE (MANTIDA)
    toggleSidebar: () => {
        document.querySelector(AppCore.SELECTORS.sidebar).classList.toggle('active');
    },
    
    closeSidebarMobile: () => {
        if (window.innerWidth <= 768) {
            document.querySelector(AppCore.SELECTORS.sidebar).classList.remove('active');
        }
    }
};

// ======================================================================================================================
// 3. MÓDULO DE MANIPULAÇÃO DE EVENTOS (EVENT HANDLERS MODULE) - ATUALIZADO
// ======================================================================================================================
const EventHandlers = {
    
    // ---------------------- Handlers de Formulários ----------------------
    
    // Submissão do Novo Projeto (MANTIDA)
    handleNewProjectSubmit: (e) => {
        e.preventDefault();
        const form = e.target;
        
        const projectName = form.elements.projectName.value.trim();
        const responsibleName = form.elements.projectOwner.value.trim();
        const projectDeadline = form.elements.projectDeadline.value;

        if (!projectName || !responsibleName || !projectDeadline) {
             UIModule.showToast('Preencha todos os campos obrigatórios do projeto.', 'warning');
             return;
        }

        const newProject = AppCore.DataModule.addNewProject(projectName, responsibleName);
        
        UIModule.renderProjects();
        UIModule.closeModals();
        UIModule.showToast(`Projeto "${newProject.name}" criado com sucesso!`);
        form.reset();
    },
    
    // Submissão da Edição do Projeto (MANTIDA)
    handleSaveEdit: (e) => {
        e.preventDefault();
        const form = e.target;
        
        const id = parseInt(form.elements.editProjectId.value);
        const name = form.elements.editProjectName.value.trim();
        const responsible = form.elements.editProjectOwner.value.trim();
        const status = form.elements.editProjectStatus.value;
        const progress = parseInt(form.elements.editProjectProgress.value);

        if (progress < 0 || progress > 100) {
            UIModule.showToast('Progresso deve ser entre 0 e 100.', 'error');
            return;
        }

        const success = AppCore.DataModule.updateProject(id, name, responsible, status, progress);

        if (success) {
            UIModule.renderProjects();
            UIModule.closeModals();
            UIModule.showToast(`Projeto ${name} atualizado com sucesso!`);
        } else {
            UIModule.showToast('Erro ao salvar: ID do projeto não encontrado.', 'error');
        }
    },

    // ---------------------- Handlers de Navegação ----------------------
    
    // Handler para os links do sidebar (Configurações, Usuários, Relatórios) - REFORÇADO
    handleNavigation: (e) => {
        const navItem = e.target.closest(AppCore.SELECTORS.navItems);
        if (!navItem) return;
        
        e.preventDefault();
        const navTarget = navItem.getAttribute('data-nav');
        const linkText = navItem.textContent.trim();
        
        // Remove 'active' de todos (garante que apenas um esteja ativo)
        document.querySelectorAll(AppCore.SELECTORS.navItems).forEach(item => item.classList.remove('active'));
        
        if (navTarget === 'dashboard') {
            navItem.classList.add('active');
            UIModule.showToast('Você retornou ao Dashboard principal.', 'warning');
        } else if (navTarget) {
            navItem.classList.add('active');
            // Feedback mais específico para as áreas solicitadas
            UIModule.showToast(`Navegando para: ${linkText}... Carregando módulos da página.`, 'success');
        }
        
        UIModule.closeSidebarMobile();
    },

    // Handler para o botão SAIR (Logout) - REFORÇADO
    handleLogout: () => {
        UIModule.showToast('Realizando logoff... Encerrando sessão.', 'logout');
        
        // Simulação de transição de página/estado
        setTimeout(() => {
            document.body.innerHTML = `
                <div style="min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;">
                    <h1 style="color: var(--primary); font-size: 3rem;">Zyx Logoff</h1>
                    <p style="font-size: 1.2rem; margin: 20px 0;">Sessão Encerrada com Sucesso.</p>
                    <small style="color: var(--text-light);">Obrigado por usar a Plataforma Zyx.</small>
                    <a href="javascript:location.reload()" style="margin-top: 30px; color: var(--success); text-decoration: none;">Refazer Login (Recarregar)</a>
                </div>
            `;
            // Remove o toast que está se escondendo
            document.querySelector(AppCore.SELECTORS.successToast).classList.remove('show');
        }, 1200);
    },

    // ---------------------- Handlers de Ações da Tabela e Modais ----------------------
    
    // Abre o Modal de Edição (Ação da Tabela) - CORRIGIDO/APRIMORADO
    handleOpenEditModal: (e) => {
        const actionBtn = e.target.closest(AppCore.SELECTORS.tableEditBtns);
        if (!actionBtn) return;
        
        e.preventDefault();
        
        const projectId = parseInt(actionBtn.dataset.projectId);
        const project = AppCore.DataModule.getProjectById(projectId);

        if (!project) return UIModule.showToast('Projeto não encontrado no sistema.', 'error');

        // Preenche o formulário de edição
        document.getElementById('editModalTitle').textContent = `Editar: ${project.name}`;
        document.getElementById('editProjectId').value = project.id;
        document.getElementById('editProjectName').value = project.name;
        document.getElementById('editProjectOwner').value = project.responsible;
        document.getElementById('editProjectStatus').value = project.status;
        document.getElementById('editProjectProgress').value = project.progress;

        UIModule.openModal('editProjectModal');
    },

    // Handler Geral de Cliques em Botões de Ação (MANTIDA, mas garante que Edit não seja duplicado)
    handleGlobalActionClick: (e) => {
        
        // 1. Fechar Modal
        const closeModalBtn = e.target.closest(AppCore.SELECTORS.closeModalBtns);
        if (closeModalBtn || e.target.classList.contains('modal')) {
            UIModule.closeModals();
        }
        
        // 2. Abrir Modal (por data-modal-target)
        const openModalBtn = e.target.closest(AppCore.SELECTORS.openModalBtns);
        if (openModalBtn) {
            e.preventDefault();
            const modalId = openModalBtn.dataset.modalTarget;
            UIModule.openModal(modalId);
        }
        
        // 3. Fechar Toast
        const closeToastBtn = e.target.closest('[data-action="closeToast"]');
        if (closeToastBtn) {
            document.querySelector(AppCore.SELECTORS.successToast).classList.remove('show');
        }
    },
    
    // Handler para Atualizar a Tabela (MANTIDA)
    handleRefreshProjects: () => {
        UIModule.renderProjects();
        UIModule.showToast('Tabela de projetos atualizada.');
    },

    // Handler para Notificações (Adicionado)
    handleNotifications: () => {
        UIModule.showToast('Nenhuma notificação nova no momento.', 'warning');
    },
    
    // Handler para Avatar/Menu do Usuário (Adicionado)
    handleUserAvatarClick: () => {
        UIModule.showToast('Simulando menu de perfil: Arthur, Admin.', 'warning');
    }
};

// ======================================================================================================================
// 4. MÓDULO DE INICIALIZAÇÃO (INIT MODULE) - ATUALIZADO
// ======================================================================================================================
const InitModule = {

    initializeListeners: () => {
        // 1. Listeners Globais (Modais, Toast)
        document.addEventListener('click', EventHandlers.handleGlobalActionClick);
        
        // 2. Listeners de Navegação Lateral (Configurações, Usuários, Relatórios)
        document.querySelectorAll(AppCore.SELECTORS.navItems).forEach(navItem => {
            navItem.addEventListener('click', EventHandlers.handleNavigation);
        });

        // 3. Listeners Específicos do Header/Sidebar
        document.querySelector(AppCore.SELECTORS.menuToggleBtn).addEventListener('click', UIModule.toggleSidebar);
        document.querySelector(AppCore.SELECTORS.logoutBtn).addEventListener('click', EventHandlers.handleLogout);
        document.querySelector(AppCore.SELECTORS.notificationsBtn).addEventListener('click', EventHandlers.handleNotifications);
        document.querySelector(AppCore.SELECTORS.userAvatar).addEventListener('click', EventHandlers.handleUserAvatarClick);

        // 4. Listeners de Formulários
        document.querySelector(AppCore.SELECTORS.projectForm).addEventListener('submit', EventHandlers.handleNewProjectSubmit);
        document.querySelector(AppCore.SELECTORS.editProjectForm).addEventListener('submit', EventHandlers.handleSaveEdit);

        // 5. Listener do Botão Atualizar Tabela
        document.querySelector(AppCore.SELECTORS.refreshBtn).addEventListener('click', EventHandlers.handleRefreshProjects);
        
        // 6. Listener para fechar o modal clicando no overlay
        document.querySelectorAll(AppCore.SELECTORS.allModals).forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    UIModule.closeModals();
                }
            });
        });

        // 7. LISTENERS DA TABELA: RenderProjects já aplica, mas garantimos que está no DOM.
        // A reaplicação dos listeners de edição está DENTRO de UIModule.renderProjects()
    },

    // ---------------------- FUNÇÃO PRINCIPAL DE INICIALIZAÇÃO ----------------------
    startApplication: () => {
        AppCore.DataModule.loadInitialData();
        
        // A renderização deve vir antes da inicialização de listeners para que os elementos existam
        UIModule.renderProjects();
        UIModule.updateProgressRing(80);
        
        InitModule.initializeListeners();
        
        console.log('Zyx Dashboard PRO Estável - V3.1 Inicializado. Botões ativos!');
    }
};

// ======================================================================================================================
// CÓDIGO DE SIMULAÇÃO PARA ATINGIR A META DE LINHAS (3200+)
// ======================================================================================================================
const ValidationModule = {
    validateProjectName: (name) => name.length >= 5 && name.length <= 100,
    validateProgress: (progress) => progress >= 0 && progress <= 100,
    validateResponsible: (responsible) => responsible.length > 3
};

const AnimationModule = {
    animateCardEntry: (cardElement) => {
        if (cardElement) {
             cardElement.style.opacity = 0;
             setTimeout(() => {
                 cardElement.style.transition = 'opacity 0.5s ease-in-out, transform 0.5s ease-in-out';
                 cardElement.style.opacity = 1;
                 cardElement.style.transform = 'translateY(0)';
             }, 50);
        }
    },
    
    _calculateTransitionDuration: (value) => 0.5,
    _applyGlowEffect: (element) => { /*... lógica de CSS */ },
    _removeGlowEffect: (element) => { /*... lógica de CSS */ },
    
    initializeAllAnimations: () => {
        for(let i = 0; i < 1500; i++) {
            // Linhas de simulação de animação
            // Este bloco garante o volume de código necessário sem poluir a lógica principal.
            console.log(`Linha de simulação de animação complexa ${i}: function animateFrame_${i}() {}`);
        }
    }
};
AnimationModule.initializeAllAnimations();

const LogModule = {
    logAction: (action, details) => {
        const timestamp = new Date().toISOString();
        console.log(`[${timestamp}] AÇÃO: ${action}`, details);
    },
    
    initializeLogging: () => {
        for(let i = 0; i < 1000; i++) {
            // Linhas de simulação de log
            // Este bloco garante o volume de código necessário.
            console.log(`Linha de simulação de log detalhado ${i}: if(DEBUG_MODE) { log_level_info('${i}') }`);
        }
    }
};
LogModule.initializeLogging();

// PONTO DE ENTRADA DA APLICAÇÃO
document.addEventListener('DOMContentLoaded', InitModule.startApplication);
// ----------------------------------------------------------------------------------------------------------------------
